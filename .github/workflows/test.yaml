name: GCP Artifact Registry Deployment
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev
    strategy:
      matrix:
        python-version: [ "3.11" ]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          create_credentials_file: true
          token_format: "access_token"
          workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.SERVICE_ACCOUNT }}'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: set  Artifact Registry
        run: |
          gcloud config set artifacts/repository '${{ secrets.ARTIFACT_REPOSITORY }}'
          gcloud config set artifacts/location '${{ secrets.ARTIFACT_LOCATION }}'
          gcloud config set account '${{ secrets.SERVICE_ACCOUNT }}'
          gcloud artifacts print-settings python
      - name: Install Dependencies
        run: |
          python -m pip install -U pip
          pip install --index-url https://_json_key_base64:eyJ0eXBlIjoiZXh0ZXJuYWxfYWNjb3VudCIsImF1ZGllbmNlIjoiLy9pYW0uZ29vZ2xlYXBpcy5jb20vcHJvamVjdHMvNjk2MDAwNTk2NDg2L2xvY2F0aW9ucy9nbG9iYWwvd29ya2xvYWRJZGVudGl0eVBvb2xzL2dpdGh1Yi1hY2Nlc3MvcHJvdmlkZXJzL2dpdGh1YiIsInN1YmplY3RfdG9rZW5fdHlwZSI6InVybjppZXRmOnBhcmFtczpvYXV0aDp0b2tlbi10eXBlOmp3dCIsInRva2VuX3VybCI6Imh0dHBzOi8vc3RzLmdvb2dsZWFwaXMuY29tL3YxL3Rva2VuIiwiY3JlZGVudGlhbF9zb3VyY2UiOnsidXJsIjoiaHR0cHM6Ly9waXBlbGluZXNnaHViZXVzNi5hY3Rpb25zLmdpdGh1YnVzZXJjb250ZW50LmNvbS9YUXZBamM3WFVuaTJ5UkJjaXN5bXU0cld1YVJNbHViYzFYZzJkMldDTXd2Z3dvdjVBMy8wMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAvX2FwaXMvZGlzdHJpYnV0ZWR0YXNrL2h1YnMvQWN0aW9ucy9wbGFucy81MjQ3YTY5Mi05NWJiLTRiZGMtYWNjNS1mOGJjOTQ4NTdhZTcvam9icy8xNTE2MjYyNi0wODM2LTUxMjAtMGUwOS1iMjg0YmY5ODBlMWEvaWR0b2tlbj9hcGktdmVyc2lvbj0yLjAmYXVkaWVuY2U9aHR0cHMlM0ElMkYlMkZpYW0uZ29vZ2xlYXBpcy5jb20lMkZwcm9qZWN0cyUyRjY5NjAwMDU5NjQ4NiUyRmxvY2F0aW9ucyUyRmdsb2JhbCUyRndvcmtsb2FkSWRlbnRpdHlQb29scyUyRmdpdGh1Yi1hY2Nlc3MlMkZwcm92aWRlcnMlMkZnaXRodWIiLCJoZWFkZXJzIjp7IkF1dGhvcml6YXRpb24iOiJCZW@us-python.pkg.dev/du-labs/test-repo/simple common-utils